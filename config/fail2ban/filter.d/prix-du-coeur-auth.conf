# ============================================
# FILTRE: Bruteforce Login API
# ============================================
# Détecte les tentatives de login échouées (401/403)
# sur les routes d'authentification
# NOTE: Les erreurs 2FA (login/2fa) sont traitées séparément
# pour éviter les faux positifs (typos OTP)

[Definition]

# Regex pour détecter les échecs de login
# Format log Nginx: IP - - [date] "POST /api/auth/login HTTP/1.1" 401 ...
# IMPORTANT: Exclut /api/auth/login/2fa pour éviter bans sur typos OTP
failregex = ^<HOST> .* "POST /api/auth/login[^/2][^"]*" (401|403|429) .*$
            ^<HOST> .* "(POST|GET) /api/auth/(register|forgot-password)[^"]*" (401|403|429) .*$

# Ignorer les tentatives 2FA (gérées par un jail séparé plus tolérant)
ignoreregex = ^<HOST> .* "POST /api/auth/login/2fa[^"]*" .*$

# Mode: aggressive (recommandé)
# Chaque match = 1 échec
