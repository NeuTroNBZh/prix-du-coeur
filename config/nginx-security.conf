# ============================================
# üõ°Ô∏è NGINX SECURITY CONFIGURATION
# Protection DDoS pour Prix du Coeur
# ============================================
# 
# Ce fichier contient les configurations de s√©curit√© √† ajouter
# dans la configuration Nginx du site.
#
# INSTRUCTIONS:
# 1. Ajouter les zones limit_req dans /etc/nginx/nginx.conf (section http)
# 2. Ajouter les locations et limites dans le bloc server du site
# ============================================

# ===========================================
# SECTION 1: √Ä AJOUTER DANS nginx.conf (http block)
# ===========================================

# Zones de rate limiting - ajouter dans /etc/nginx/nginx.conf
# dans le bloc http { ... }

# limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
# limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=1r/s;
# limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=2r/m;
# limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ===========================================
# SECTION 2: √Ä AJOUTER DANS le bloc server
# ===========================================

# Copier ces lignes dans /etc/nginx/sites-available/prixducoeur.fr
# dans le bloc server { ... }

# --- Timeouts pour √©viter les attaques slowloris ---
# client_body_timeout 10s;
# client_header_timeout 10s;
# keepalive_timeout 30s;
# send_timeout 10s;

# --- Limite de connexions simultan√©es par IP ---
# limit_conn conn_limit 20;

# --- Protection API ---
# location /api/ {
#     # Rate limiting: 10 req/s avec burst de 20
#     limit_req zone=api_limit burst=20 nodelay;
#     limit_req_status 429;
#     
#     # Limite de body pour l'API (sauf upload)
#     client_max_body_size 1M;
#     
#     proxy_pass http://localhost:3002;
#     proxy_http_version 1.1;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection 'upgrade';
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     proxy_cache_bypass $http_upgrade;
#     
#     # Timeouts proxy
#     proxy_connect_timeout 30s;
#     proxy_send_timeout 30s;
#     proxy_read_timeout 30s;
# }

# --- Protection routes d'authentification (plus strict) ---
# location /api/auth/ {
#     limit_req zone=auth_limit burst=5 nodelay;
#     limit_req_status 429;
#     client_max_body_size 100K;
#     
#     proxy_pass http://localhost:3002;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
# }

# --- Protection uploads (limite stricte) ---
# location /api/transactions/upload {
#     limit_req zone=upload_limit burst=2 nodelay;
#     limit_req_status 429;
#     client_max_body_size 10M;
#     
#     proxy_pass http://localhost:3002;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     
#     # Timeout plus long pour les uploads
#     proxy_read_timeout 60s;
# }

# --- Bloquer les user-agents suspects ---
# if ($http_user_agent ~* (bot|crawler|spider|scraper|wget|curl|nikto|sqlmap)) {
#     return 403;
# }

# --- Bloquer les requ√™tes sans Host header ---
# if ($host = "") {
#     return 444;
# }

# ===========================================
# COMMANDES POUR APPLIQUER
# ===========================================
# 
# 1. Editer nginx.conf:
#    sudo nano /etc/nginx/nginx.conf
#    Ajouter les limit_req_zone dans le bloc http {}
#
# 2. Editer la config du site:
#    sudo nano /etc/nginx/sites-available/prixducoeur.fr
#    Remplacer/ajouter les locations
#
# 3. Tester la config:
#    sudo nginx -t
#
# 4. Recharger Nginx:
#    sudo systemctl reload nginx
